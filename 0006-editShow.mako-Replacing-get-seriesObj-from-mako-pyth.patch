From 2d44548ef20bf7783bdbf4b27209ef85ed3f37ad Mon Sep 17 00:00:00 2001
From: P0psicles <rogier@headshots.nl>
Date: Fri, 2 Mar 2018 12:05:38 +0100
Subject: [PATCH 6/9] editShow.mako: Replacing get seriesObj from mako python
 to use apiv2.

---
 themes/dark/templates/editShow.mako                | 93 ++++++++--------------
 .../vue-components/anidbReleaseGroupUi.mako        | 48 +++++++++++
 .../templates/vue-components/selectListUi.mako     | 43 ++++++++++
 3 files changed, 122 insertions(+), 62 deletions(-)
 create mode 100644 themes/dark/templates/vue-components/anidbReleaseGroupUi.mako
 create mode 100644 themes/dark/templates/vue-components/selectListUi.mako

diff --git a/themes/dark/templates/editShow.mako b/themes/dark/templates/editShow.mako
index 84f2262..f972920 100644
--- a/themes/dark/templates/editShow.mako
+++ b/themes/dark/templates/editShow.mako
@@ -40,8 +40,8 @@
                             <label for="location">
                                 <span class="component-title">Show Location</span>
                                 <span class="component-desc">
-                                    <input type="hidden" name="indexername" id="form-indexername" :value="seriesObj.indexer" />
-                                    <input type="hidden" name="seriesid" id="form-seriesid" :value="seriesObj.id[seriesObj.indexer]" />
+                                    <input type="hidden" name="indexername" id="form-indexername" :value="getSafe(seriesObj.indexer, '')" />
+                                    <input type="hidden" name="seriesid" id="form-seriesid" :value="getSafe(seriesObj.id[seriesObj.indexer], ''/>
                                     <input type="text" name="location" id="location" :value="seriesObj.config.location" class="form-control form-control-inline input-sm input350" @change="storeConfig($event)"/>
                                 </span>
                             </label>
@@ -117,7 +117,8 @@
                                 <span class="component-desc">
                                     <input type="checkbox" id="anime" name="anime" v-model="seriesObj.config.anime" @change="storeConfig($event)"> check if the show is Anime and episodes are released as Show.265 rather than Show.S02E03<br>
                                     % if show.is_anime:
-                                        <%include file="/inc_blackwhitelist.mako"/>
+                                        <!-- <%include file="/inc_blackwhitelist.mako"/> -->
+                                        <anidb-release-group-ui></anidb-release-group-ui>
                                     % endif
                                 </span>
                             </label>
@@ -219,74 +220,33 @@
 <%block name="scripts">
     <script type="text/javascript" src="js/quality-chooser.js?${sbPID}"></script>
     <script type="text/javascript" src="js/edit-show.js"></script>
-% if show.is_anime:
-    <script type="text/javascript" src="js/blackwhite.js?${sbPID}"></script>
-% endif
 <script src="js/lib/vue.js"></script>
+<%include file="/vue-components/selectListUi.mako"/>
+<%include file="/vue-components/anidbReleaseGroupUi.mako"/>
 <%
     seriesObj = json.dumps(show.to_json());
 %>
 <script>
-// register the component
-Vue.component('select-list', {
-    template:
-        '<div class="select-list"> \
-            <div v-for="item of editItems"> \
-                <input style="display: inline-block" type="text" @change="sendValues" v-model="item.value"/> \
-                <img style="display: inline-block" src="images/no16.png" alt="N" width="16" height="16" @click="deleteItem(item)"> \
-            </div> \
-            <input style="display: inline-block" type="text" v-model="newItem"/> \
-            <img style="display: inline-block" src="images/pencil_add.png" alt="N" width="16" height="16" @click="addItem"> \
-        </div>'
-    ,
-    props: ['listItems'],
-    mounted() {
-        this.editItems = this.listItems.slice();
-    },
-    data: function() {
-        return {
-            editItems: [],
-            newItem: '',
-            indexCounter: 0
-        }
-    },
-    methods: {
-		sendValues: function() {
-			this.$emit('change', this.editItems);
-        },
-        addItem: function(evt) {
-            this.editItems.push({id: this.indexCounter, value: this.newItem});
-            this.indexCounter += 1;
-            this.newItem = '';
-            this.sendValues();
-        },
-        deleteItem: function(item) {
-            this.editItems = this.editItems.filter(e => e !== item);
-            this.newItem = item.value;
-            this.sendValues();
-        }
-    }
-});
-
 var startVue = function() {
     const app = new Vue({
         el: '#config-content',
         data() {
-            const seriesObj = ${seriesObj};
-            const seriesSlug = seriesObj.id.slug;
-            const exceptions = seriesObj.config.aliases;
+            // Python conversions
+            const seriesObj = this.loadSeries();
+            
+            // JS only
+            const exceptions = [];
             return {
+                seriesSlug: $('#series-slug').attr('value'),
                 config: MEDUSA.config,
                 exceptions: exceptions,
-                seriesSlug: seriesSlug,
                 seriesObj: seriesObj,
-                subtitles: seriesObj.config.subtitlesEnabled,
-                folders: seriesObj.config.flattenFolders,
                 defaultEpisodeStatusOptions: [
                     {text: 'Wanted', value: 'Wanted'},
                     {text: 'Skipped', value: 'Skipped'},
                     {text: 'Ignored', value: 'Ignored'}
-                ]
+                ],
+                saveStatus: ''
             }
         },
         methods: {
@@ -297,8 +257,8 @@ var startVue = function() {
             prettyPrintJSON: function(x) {
                 return JSON.stringify(x, undefined, 4)
             },
-            storeConfig: function(x) {
-                api.patch('series/' + this.seriesSlug, {
+            storeConfig: async function() {
+                const data = {
                     config: {
                         dvdOrder: this.seriesObj.config.dvdOrder,
                         flattenFolders: this.seriesObj.config.flattenFolders,
@@ -315,13 +275,22 @@ var startVue = function() {
                             // blacklist: this.seriesObj.config.release.blacklist,
                             // whitelist: this.seriesObj.config.release.whitelist
                         }
-                            
                     }
-                }).then(response => {
-                    log.info(response);
-                }).catch(err => {
-                    log.error(err);
-                });
+                }
+                const response = await api.patch('series/' + this.seriesSlug, data);
+                if (response.status === 200) {
+                    this.saveStatus = 'Successfully patched series';
+                } else {
+                    this.saveStatus = 'Problem trying to archive using payload: ' + data;
+                }
+            },
+            loadSeries: () => {
+                const url = 'series/' + $('#series-slug').attr('value');
+                const response = await api.get('series/' + this.seriesSlug);
+                return response.data;
+            },
+            getSafe: (item, defaultValue) => {
+                return this.seriesObj ? item : defaultValue;
             },
             onChangeIgnoredWords: function(items) {
 		        console.log('Event from child component emitted', items);
diff --git a/themes/dark/templates/vue-components/anidbReleaseGroupUi.mako b/themes/dark/templates/vue-components/anidbReleaseGroupUi.mako
new file mode 100644
index 0000000..ea79df4
--- /dev/null
+++ b/themes/dark/templates/vue-components/anidbReleaseGroupUi.mako
@@ -0,0 +1,48 @@
+<script type="text/x-template" id="anidb-release-group-ui">
+    <div id="anidb_release_group_ui_wrapper">
+        <div class="row">
+                <div class="col-sm-4 left-whitelist" >
+                    <ul>
+                        <li v-for="item in releaseWhitelist">{{ item }}</li>
+                    </ul>
+                </div>
+                <div class="col-sm-4 center-available">
+                    <ul>
+                        <li v-for="item in releaseGroups">{{ item }}</li>
+                    </ul>
+                </div>
+                <div class="col-sm-4 right-blacklist">
+                    <ul>
+                        <li v-for="item in releaseblacklist">{{ item }}</li>
+                    </ul>
+                </div>
+        </div>
+    </div>
+</script>
+<script>
+Vue.component('anidb-release-group-ui', {
+    name: 'anidb-release-group-ui',
+    template: '#anidb-release-group-ui',
+    props: ['series', 'blacklist', 'whitelist', 'allGroups'],
+    data() {
+        return {
+            // JS only
+            series: '',
+            releaseblacklist: [],
+            releaseWhitelist: [],
+            releaseGroups: []
+        };
+    },
+    mounted() {
+        this.releaseSeries = this.series;
+        this.releaseblacklist = this.blacklist;
+        this.releaseWhitelist = this.whitelist;
+        this.releaseGroups = this.allGroups;
+    },
+    methods: {
+        sendValues: function() {
+            this.$emit('change', this.editItems);
+        }
+    }
+});
+</script>
diff --git a/themes/dark/templates/vue-components/selectListUi.mako b/themes/dark/templates/vue-components/selectListUi.mako
new file mode 100644
index 0000000..66179a6
--- /dev/null
+++ b/themes/dark/templates/vue-components/selectListUi.mako
@@ -0,0 +1,43 @@
+<script type="text/x-template" id="select-list">
+    <div class="select-list">
+            <div v-for="item of editItems">
+                <input style="display: inline-block" type="text" @change="sendValues" v-model="item.value"/>
+                <img style="display: inline-block" src="images/no16.png" alt="N" width="16" height="16" @click="deleteItem(item)">
+            </div>
+            <input style="display: inline-block" type="text" v-model="newItem"/>
+            <img style="display: inline-block" src="images/pencil_add.png" alt="N" width="16" height="16" @click="addItem">
+    </div>
+</script>
+<script>
+    // register the component
+    Vue.component('select-list', {
+        template: '#select-list',
+        props: ['listItems'],
+        mounted() {
+            this.editItems = this.listItems;
+        },
+        data: function() {
+            return {
+                editItems: [],
+                newItem: '',
+                indexCounter: 0
+            }
+        },
+        methods: {
+            sendValues: function() {
+                this.$emit('change', this.editItems);
+            },
+            addItem: function(evt) {
+                this.editItems.push({id: this.indexCounter, value: this.newItem});
+                this.indexCounter += 1;
+                this.newItem = '';
+                this.sendValues();
+            },
+            deleteItem: function(item) {
+                this.editItems = this.editItems.filter(e => e !== item);
+                this.newItem = item.value;
+                this.sendValues();
+            }
+        }
+    });
+</script>
-- 
2.6.3.windows.1

